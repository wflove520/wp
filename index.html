<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç§äººäº‘ç›˜ Pro - æé€Ÿç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">

    <div id="redirect-view" class="hidden flex flex-col items-center justify-center min-h-screen p-4 text-center">
        <div class="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full">
            <div id="status-icon" class="text-6xl mb-4">â³</div>
            <h2 id="status-title" class="text-xl font-bold mb-2">å®‰å…¨æ£€æµ‹ä¸­...</h2>
            <p id="status-desc" class="text-gray-500 text-sm mb-4">æ­£åœ¨éªŒè¯é“¾æ¥æœ‰æ•ˆæ€§</p>
            <div id="countdown" class="text-3xl font-mono font-bold text-blue-600 hidden">3</div>
        </div>
    </div>

    <div id="admin-view" class="hidden max-w-2xl mx-auto p-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-black text-gray-900">â˜ï¸ æˆ‘çš„äº‘ç›˜</h1>
                <p class="text-xs text-gray-400">ModelScope ç›´è¿ Â· æ™ºèƒ½é™æ—¶åˆ†äº«</p>
            </div>
            <button onclick="loadFileList()" class="bg-white p-2 rounded-full shadow-sm hover:shadow-md active:scale-95">ğŸ”„</button>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden min-h-[300px]">
            <div id="loading" class="flex flex-col items-center justify-center h-64 text-gray-400">
                <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full loading mb-2"></div>
                <p class="text-xs">æ­£åœ¨è¿æ¥æ•°æ®ä»“åº“...</p>
            </div>
            <div id="file-list" class="hidden divide-y divide-gray-50"></div>
        </div>

        <div id="share-modal" class="fixed inset-0 bg-black/40 hidden items-end sm:items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white w-full sm:w-96 rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl transition-all" id="modal-panel">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">åˆ›å»ºåˆ†äº«é“¾æ¥</h3><button onclick="closeModal()" class="text-gray-400">âœ•</button></div>
                <div class="bg-blue-50 p-3 rounded-xl mb-4 flex items-center gap-3">
                    <div class="bg-blue-100 p-2 rounded-lg text-xl">ğŸ“„</div>
                    <div class="overflow-hidden"><p class="text-xs text-blue-500 font-bold uppercase">å·²é€‰æ–‡ä»¶</p><p id="selected-filename" class="text-sm font-medium truncate text-blue-900"></p></div>
                </div>
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button onclick="setExpiry('10m')" class="border p-2 rounded-xl text-xs hover:bg-blue-500 hover:text-white">âš¡ 10åˆ†</button>
                    <button onclick="setExpiry('1d')" class="border p-2 rounded-xl text-xs hover:bg-blue-500 hover:text-white">ğŸ“… 1å¤©</button>
                    <button onclick="setExpiry('7d')" class="border p-2 rounded-xl text-xs hover:bg-blue-500 hover:text-white">ğŸ—“ï¸ 7å¤©</button>
                    <button onclick="setExpiry('30d')" class="border p-2 rounded-xl text-xs hover:bg-blue-500 hover:text-white">ğŸ“† 1æœˆ</button>
                    <button onclick="setExpiry('forever')" class="col-span-2 border p-2 rounded-xl text-xs bg-green-50 text-green-700 font-bold hover:bg-green-600 hover:text-white">âˆ æ°¸ä¹…</button>
                </div>
                <div id="result-area" class="hidden">
                    <input type="text" id="final-link" readonly class="w-full bg-gray-50 border p-3 rounded-xl text-xs mb-2">
                    <button onclick="copyLink()" class="w-full bg-black text-white py-3 rounded-xl font-bold">å¤åˆ¶å¹¶å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const MS_USER = 'wflove520';
        const MS_REPO = 'my_disk_001';
        const MS_BASE = `https://www.modelscope.cn/datasets/${MS_USER}/${MS_REPO}/resolve/master/`;

        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('f') && params.get('e')) {
                handleRedirect(params.get('f'), params.get('e'));
            } else {
                showAdmin();
            }
        };

        // ç›´æ¥åœ¨å‰ç«¯è·å– ModelScope åˆ—è¡¨ (å°è¯•ç»•è¿‡è·¨åŸŸ)
        async function loadFileList() {
            const listEl = document.getElementById('file-list');
            const loading = document.getElementById('loading');
            listEl.innerHTML = '';
            listEl.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                // ä½¿ç”¨ ModelScope åŸå§‹ API è·¯å¾„
                const apiUrl = `https://www.modelscope.cn/api/v1/datasets/${MS_USER}/${MS_REPO}/repo/tree?Revision=master&Root=`;
                const res = await fetch(apiUrl);
                const data = await res.json();

                if (data.Code !== 200) throw new Error("è·å–æ•°æ®å¤±è´¥");

                const files = data.Data.Files.filter(f => f.Name !== '.gitattributes' && f.Name !== 'README.md');
                
                loading.classList.add('hidden');
                listEl.classList.remove('hidden');

                listEl.innerHTML = files.map(file => `
                    <div onclick="openShareModal('${file.Name}')" class="p-4 hover:bg-blue-50 cursor-pointer flex items-center justify-between group">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="bg-gray-100 p-2 rounded-lg group-hover:bg-blue-200">ğŸ“‚</div>
                            <div class="min-w-0">
                                <h3 class="text-sm font-bold truncate">${file.Name}</h3>
                                <p class="text-[10px] text-gray-400">${(file.Size/1024/1024).toFixed(2)} MB</p>
                            </div>
                        </div>
                        <span class="text-gray-300 group-hover:text-blue-500">ğŸ”—</span>
                    </div>
                `).join('');
            } catch (e) {
                loading.innerHTML = `<p class="text-red-400 text-xs text-center p-4">åˆ—è¡¨åŠ è½½å¤±è´¥<br>è¯·ç¡®ä¿ ModelScope ä»“åº“ä¸º Public</p>`;
            }
        }

        // --- è·³è½¬ä¸ç®¡ç†é€»è¾‘åŒä¹‹å‰ ---
        function handleRedirect(file, expiryTs) {
            document.getElementById('redirect-view').classList.remove('hidden');
            const now = Date.now();
            if (now > parseInt(expiryTs)) {
                document.getElementById('status-icon').innerText = "ğŸ›‘";
                document.getElementById('status-title').innerText = "é“¾æ¥å·²å¤±æ•ˆ";
                return;
            }
            document.getElementById('countdown').classList.remove('hidden');
            let timer = 3;
            const interval = setInterval(() => {
                timer--;
                document.getElementById('countdown').innerText = timer;
                if (timer <= 0) { clearInterval(interval); window.location.href = MS_BASE + encodeURIComponent(file); }
            }, 1000);
        }

        function showAdmin() { document.getElementById('admin-view').classList.remove('hidden'); loadFileList(); }
        let currentFile = '';
        function openShareModal(f) { 
            currentFile = f; 
            document.getElementById('selected-filename').innerText = f; 
            document.getElementById('share-modal').classList.remove('hidden');
            document.getElementById('share-modal').classList.add('flex');
            document.getElementById('result-area').classList.add('hidden');
        }
        function closeModal() { document.getElementById('share-modal').classList.add('hidden'); }
        function setExpiry(type) {
            const now = Date.now();
            let exp = 0;
            if(type==='10m') exp = now + 600000;
            else if(type==='1d') exp = now + 86400000;
            else if(type==='7d') exp = now + 604800000;
            else if(type==='30d') exp = now + 2592000000;
            else exp = now + 3153600000000;
            const link = `${window.location.origin}${window.location.pathname}?f=${encodeURIComponent(currentFile)}&e=${exp}`;
            document.getElementById('final-link').value = link;
            document.getElementById('result-area').classList.remove('hidden');
        }
        function copyLink() {
            navigator.clipboard.writeText(document.getElementById('final-link').value);
            alert('å¤åˆ¶æˆåŠŸï¼');
            closeModal();
        }
    </script>
</body>
</html>
