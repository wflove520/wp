<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç§äººäº‘ç›˜ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">

    <div id="redirect-view" class="hidden flex flex-col items-center justify-center min-h-screen p-4 text-center">
        <div class="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full">
            <div id="status-icon" class="text-6xl mb-4">â³</div>
            <h2 id="status-title" class="text-xl font-bold mb-2">å®‰å…¨æ£€æµ‹ä¸­...</h2>
            <p id="status-desc" class="text-gray-500 text-sm mb-4">æ­£åœ¨éªŒè¯é“¾æ¥æœ‰æ•ˆæ€§</p>
            <div id="countdown" class="text-3xl font-mono font-bold text-blue-600 hidden">3</div>
        </div>
    </div>

    <div id="admin-view" class="hidden max-w-2xl mx-auto p-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-black text-gray-900">â˜ï¸ æˆ‘çš„äº‘ç›˜</h1>
                <p class="text-xs text-gray-400">ModelScope ç›´è¿ Â· æ™ºèƒ½é™æ—¶åˆ†äº«</p>
            </div>
            <button onclick="loadFileList()" class="bg-white p-2 rounded-full shadow-sm hover:shadow-md transition-all active:scale-95">
                ğŸ”„
            </button>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden min-h-[400px]">
            <div id="loading" class="flex flex-col items-center justify-center h-64 text-gray-400">
                <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full loading mb-2"></div>
                <p class="text-xs">æ­£åœ¨è¿æ¥æ•°æ®ä»“åº“...</p>
            </div>
            
            <div id="file-list" class="hidden divide-y divide-gray-50">
                </div>
        </div>

        <div id="share-modal" class="fixed inset-0 bg-black/40 hidden items-end sm:items-center justify-center z-50 backdrop-blur-sm transition-all">
            <div class="bg-white w-full sm:w-96 rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl transform transition-transform translate-y-full sm:translate-y-0" id="modal-panel">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">åˆ›å»ºåˆ†äº«é“¾æ¥</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
                </div>
                
                <div class="bg-blue-50 p-3 rounded-xl mb-4 flex items-center gap-3">
                    <div class="bg-blue-100 p-2 rounded-lg text-xl">ğŸ“„</div>
                    <div class="overflow-hidden">
                        <p class="text-xs text-blue-500 font-bold uppercase">å·²é€‰æ–‡ä»¶</p>
                        <p id="selected-filename" class="text-sm font-medium truncate text-blue-900">game.zip</p>
                    </div>
                </div>

                <p class="text-xs text-gray-500 mb-2 font-bold ml-1">é€‰æ‹©æœ‰æ•ˆæœŸï¼š</p>
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button onclick="setExpiry('10m')" class="time-btn border border-gray-200 py-2 rounded-xl text-xs font-medium hover:bg-blue-50 hover:border-blue-300 focus:bg-blue-600 focus:text-white transition-colors">âš¡ 10åˆ†é’Ÿ</button>
                    <button onclick="setExpiry('1d')" class="time-btn border border-gray-200 py-2 rounded-xl text-xs font-medium hover:bg-blue-50 hover:border-blue-300 focus:bg-blue-600 focus:text-white transition-colors">ğŸ“… 1 å¤©</button>
                    <button onclick="setExpiry('7d')" class="time-btn border border-gray-200 py-2 rounded-xl text-xs font-medium hover:bg-blue-50 hover:border-blue-300 focus:bg-blue-600 focus:text-white transition-colors">ğŸ—“ï¸ 7 å¤©</button>
                    <button onclick="setExpiry('30d')" class="time-btn border border-gray-200 py-2 rounded-xl text-xs font-medium hover:bg-blue-50 hover:border-blue-300 focus:bg-blue-600 focus:text-white transition-colors">ğŸ“† 1 ä¸ªæœˆ</button>
                    <button onclick="setExpiry('forever')" class="time-btn col-span-2 border border-green-200 text-green-700 bg-green-50 py-2 rounded-xl text-xs font-bold hover:bg-green-100 focus:bg-green-600 focus:text-white transition-colors">âˆ æ°¸ä¹…æœ‰æ•ˆ</button>
                </div>

                <div id="result-area" class="hidden animate-pulse">
                    <input type="text" id="final-link" readonly class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-xs text-gray-600 outline-none mb-2" onclick="this.select()">
                    <button onclick="copyLink()" class="w-full bg-black text-white py-3 rounded-xl font-bold text-sm hover:bg-gray-800 active:scale-95 transition-transform">å¤åˆ¶é“¾æ¥å¹¶å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === é…ç½®åŒº ===
        const MS_BASE = "https://www.modelscope.cn/datasets/wflove520/my_disk_001/resolve/master/";

        // é¡µé¢å…¥å£
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const f = params.get('f');
            const e = params.get('e');

            if (f && e) {
                handleRedirect(f, e);
            } else {
                showAdmin();
            }
        };

        // ================= é€»è¾‘éƒ¨åˆ†ï¼šè·³è½¬ =================
        function handleRedirect(file, expiryTs) {
            document.getElementById('redirect-view').classList.remove('hidden');
            const now = Date.now();
            const exp = parseInt(expiryTs);
            const icon = document.getElementById('status-icon');
            const title = document.getElementById('status-title');
            const desc = document.getElementById('status-desc');
            const count = document.getElementById('countdown');

            // 1. æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            if (now > exp) {
                icon.innerText = "ğŸ›‘";
                title.innerText = "é“¾æ¥å·²å¤±æ•ˆ";
                title.className = "text-xl font-bold mb-2 text-red-600";
                desc.innerText = "è¯¥æ–‡ä»¶çš„åˆ†äº«æœŸé™å·²è¿‡ï¼Œæ— æ³•è®¿é—®ã€‚";
                return;
            }

            // 2. æ­£å¸¸è·³è½¬
            icon.innerText = "ğŸš€";
            title.innerText = "å‡†å¤‡ä¸‹è½½...";
            desc.innerText = "æ­£åœ¨å»ºç«‹æé€Ÿè¿æ¥";
            count.classList.remove('hidden');

            let timer = 3;
            const interval = setInterval(() => {
                timer--;
                count.innerText = timer;
                if (timer <= 0) {
                    clearInterval(interval);
                    window.location.href = MS_BASE + encodeURIComponent(file);
                }
            }, 1000);
        }

        // ================= é€»è¾‘éƒ¨åˆ†ï¼šç®¡ç† =================
        function showAdmin() {
            document.getElementById('admin-view').classList.remove('hidden');
            loadFileList();
        }

        async function loadFileList() {
            const listEl = document.getElementById('file-list');
            const loading = document.getElementById('loading');
            
            listEl.innerHTML = '';
            listEl.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                // è°ƒç”¨æˆ‘ä»¬åˆšæ‰å†™çš„ API
                const res = await fetch('/api/list');
                const files = await res.json();

                if (!files || files.length === 0) throw new Error("ç©ºä»“åº“");

                loading.classList.add('hidden');
                listEl.classList.remove('hidden');

                listEl.innerHTML = files.map(file => {
                    // æ ¼å¼åŒ–å¤§å°
                    const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                    return `
                        <div onclick="openShareModal('${file.name}')" class="p-4 hover:bg-blue-50 cursor-pointer flex items-center justify-between transition-colors group">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <div class="bg-gray-100 p-2 rounded-lg text-lg group-hover:bg-blue-200 transition-colors">ğŸ“‚</div>
                                <div class="min-w-0">
                                    <h3 class="text-sm font-bold text-gray-700 truncate">${file.name}</h3>
                                    <p class="text-[10px] text-gray-400">${sizeMB} MB Â· ${file.date}</p>
                                </div>
                            </div>
                            <button class="text-gray-300 group-hover:text-blue-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                loading.innerHTML = `<p class="text-red-400">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ api/list.js</p>`;
            }
        }

        // --- å¼¹çª—é€»è¾‘ ---
        let currentFile = '';

        function openShareModal(filename) {
            currentFile = filename;
            document.getElementById('selected-filename').innerText = filename;
            document.getElementById('share-modal').classList.remove('hidden');
            document.getElementById('share-modal').classList.add('flex');
            
            // åŠ¨ç”»
            setTimeout(() => {
                document.getElementById('modal-panel').classList.remove('translate-y-full');
            }, 10);
            
            // é‡ç½®çŠ¶æ€
            document.getElementById('result-area').classList.add('hidden');
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white', 'bg-green-600'));
        }

        function closeModal() {
            document.getElementById('modal-panel').classList.add('translate-y-full');
            setTimeout(() => {
                document.getElementById('share-modal').classList.add('hidden');
                document.getElementById('share-modal').classList.remove('flex');
            }, 300);
        }

        function setExpiry(type) {
            const now = Date.now();
            let expiryTime = 0;

            // è®¡ç®—æ—¶é—´æˆ³
            switch(type) {
                case '10m': expiryTime = now + (10 * 60 * 1000); break;
                case '1d':  expiryTime = now + (24 * 60 * 60 * 1000); break;
                case '7d':  expiryTime = now + (7 * 24 * 60 * 60 * 1000); break;
                case '30d': expiryTime = now + (30 * 24 * 60 * 60 * 1000); break;
                case 'forever': expiryTime = now + (100 * 365 * 24 * 60 * 60 * 1000); break; // 100å¹´
            }

            // ç”Ÿæˆé“¾æ¥
            const base = window.location.origin + window.location.pathname;
            // é“¾æ¥æ ¼å¼ï¼šåŸŸå/?f=æ–‡ä»¶å&e=è¿‡æœŸæ—¶é—´æˆ³
            const link = `${base}?f=${encodeURIComponent(currentFile)}&e=${expiryTime}`;

            document.getElementById('final-link').value = link;
            document.getElementById('result-area').classList.remove('hidden');
        }

        function copyLink() {
            const input = document.getElementById('final-link');
            input.select();
            document.execCommand('copy');
            alert('å¤åˆ¶æˆåŠŸï¼');
            closeModal();
        }
    </script>
</body>
</html>
